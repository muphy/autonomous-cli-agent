<project_specification>
  <project_name>CrewAI AOP - Agent Operations Platform</project_name>

  <overview>
    CrewAI 기반 AI Agent Crews를 배포, 모니터링, 확장하기 위한 Agent Operations Platform.
    CrewAI Enterprise의 핵심 기능을 참고하여 자체 구축한 오픈소스 대안 플랫폼으로,
    Crew 워크플로우 관리, 실행 추적, 실시간 모니터링, 성능 분석 기능을 제공합니다.
  </overview>

  <technology_stack>
    <frontend>
      <framework>React with Vite</framework>
      <styling>shadcn/ui + Tailwind CSS</styling>
      <state_management>React hooks, Context, TanStack Query</state_management>
      <routing>React Router</routing>
      <charts>Recharts for metrics visualization</charts>
      <workflow_editor>React Flow for visual workflow editor</workflow_editor>
    </frontend>
    <backend>
      <runtime>Python with FastAPI</runtime>
      <database>PostgreSQL</database>
      <orm>SQLAlchemy with Alembic migrations</orm>
      <async>asyncio, asyncpg</async>
      <crewai>CrewAI SDK integration</crewai>
    </backend>
    <communication>
      <api>REST API for commands (Crew 실행, 중지, 설정 등)</api>
      <realtime>SSE (Server-Sent Events) for response streaming</realtime>
      <pattern>POST /api/crews/{id}/run -> SSE stream for logs, status, results</pattern>
    </communication>
    <infrastructure>
      <containerization>Docker + Docker Compose</containerization>
      <documentation>Swagger/OpenAPI auto-generation</documentation>
      <testing>Playwright for E2E tests, pytest for backend</testing>
    </infrastructure>
  </technology_stack>

  <core_features>
    <crew_deployment>
      <title>Crew 배포 관리</title>
      <features>
        - Crew 정의 생성, 수정, 삭제
        - Agent 구성 (role, goal, backstory, tools)
        - Task 정의 및 의존성 설정
        - 배포 상태 관리 (draft, deployed, stopped)
        - GitHub 저장소 연동 (선택적)
        - 환경 변수 및 시크릿 관리
      </features>
    </crew_deployment>

    <agent_templates>
      <title>Agent 템플릿 라이브러리</title>
      <features>
        - 재사용 가능한 Agent 템플릿
        - 카테고리별 분류 (Research, Writing, Analysis, etc.)
        - 템플릿 공유 및 가져오기
        - 커스텀 템플릿 생성
      </features>
    </agent_templates>

    <task_orchestration>
      <title>Task 오케스트레이션</title>
      <features>
        - Task 순서 및 의존성 관리
        - Sequential / Hierarchical 프로세스 지원
        - Task 입출력 매핑
        - 조건부 실행 설정
      </features>
    </task_orchestration>

    <visual_workflow_editor>
      <title>시각적 워크플로우 에디터</title>
      <features>
        - 드래그 앤 드롭 Crew 구성
        - Agent 노드와 Task 노드 연결
        - 실시간 유효성 검사
        - YAML/JSON 코드 뷰 동기화
      </features>
    </visual_workflow_editor>

    <rest_api>
      <title>REST API 통합</title>
      <features>
        - Crew 실행 API 엔드포인트
        - 외부 시스템 통합을 위한 API
        - API 키 발급 및 관리
        - Rate limiting 설정
        - Webhook 등록 및 관리
      </features>
    </rest_api>

    <observability>
      <title>관찰성 (Observability)</title>
      <features>
        - Traces: 실행 흐름 추적
        - 함수 호출 로깅 (Before/After/Around)
        - LLM API 호출 추적 (토큰, 응답시간)
        - 에러/예외 캡처 및 알림
        - 커스텀 후크 포인트 설정
      </features>
    </observability>

    <realtime_monitoring>
      <title>실시간 모니터링 대시보드</title>
      <features>
        - Crew/Agent/Task 실행 상태 실시간 표시
        - SSE 기반 로그 스트리밍
        - 메트릭 차트 (토큰 사용량, 응답시간, 비용)
        - 알림 설정 (Slack, Email, Webhook)
        - 실행 타임라인 뷰
      </features>
    </realtime_monitoring>

    <execution_history>
      <title>실행 기록/분석</title>
      <features>
        - 실행 히스토리 조회 및 검색
        - 필터링 (날짜, Crew, 상태, 비용 등)
        - 성능 분석 리포트
        - 비용 추적 및 예산 알림
        - 데이터 내보내기 (CSV, JSON)
      </features>
    </execution_history>

    <tool_repository>
      <title>도구 저장소 (Tool Repository)</title>
      <features>
        - 커스텀 Tool 등록 및 관리
        - Tool 버전 관리
        - Tool 문서화
        - Tool 의존성 관리
      </features>
    </tool_repository>

    <user_management>
      <title>사용자 관리</title>
      <features>
        - 다중 사용자 인증 (JWT)
        - 역할 기반 접근 제어 (Admin, Developer, Viewer)
        - 팀/워크스페이스 관리
        - API 키 사용자별 발급
      </features>
    </user_management>
  </core_features>

  <database_schema>
    <tables>
      <users>
        - id (UUID, PK)
        - email (unique)
        - password_hash
        - name
        - role (admin, developer, viewer)
        - created_at, updated_at
        - last_login_at
        - settings (JSONB)
      </users>

      <teams>
        - id (UUID, PK)
        - name
        - created_at, updated_at
      </teams>

      <team_members>
        - id (UUID, PK)
        - team_id (FK)
        - user_id (FK)
        - role (owner, member)
        - joined_at
      </team_members>

      <crews>
        - id (UUID, PK)
        - team_id (FK)
        - name
        - description
        - config (JSONB: agents, tasks, process type)
        - status (draft, deployed, stopped)
        - version
        - created_by (FK users)
        - created_at, updated_at
      </crews>

      <agent_templates>
        - id (UUID, PK)
        - team_id (FK, nullable for global)
        - name
        - description
        - category
        - config (JSONB: role, goal, backstory, tools)
        - is_public
        - created_by (FK users)
        - created_at, updated_at
      </agent_templates>

      <tools>
        - id (UUID, PK)
        - team_id (FK)
        - name
        - description
        - tool_type (builtin, custom)
        - config (JSONB)
        - version
        - created_at, updated_at
      </tools>

      <deployments>
        - id (UUID, PK)
        - crew_id (FK)
        - status (pending, running, stopped, failed)
        - api_endpoint
        - deployed_at
        - stopped_at
        - config (JSONB: environment variables)
      </deployments>

      <executions>
        - id (UUID, PK)
        - crew_id (FK)
        - deployment_id (FK)
        - status (pending, running, completed, failed, cancelled)
        - inputs (JSONB)
        - outputs (JSONB)
        - started_at
        - completed_at
        - error_message
        - triggered_by (user_id or api_key_id)
      </executions>

      <traces>
        - id (UUID, PK)
        - execution_id (FK)
        - parent_trace_id (FK, nullable)
        - trace_type (crew, agent, task, tool, llm_call)
        - name
        - status (running, completed, failed)
        - inputs (JSONB)
        - outputs (JSONB)
        - started_at
        - completed_at
        - metadata (JSONB: tokens, cost, model, etc.)
      </traces>

      <logs>
        - id (UUID, PK)
        - execution_id (FK)
        - trace_id (FK, nullable)
        - level (debug, info, warning, error)
        - message
        - metadata (JSONB)
        - created_at
      </logs>

      <metrics>
        - id (UUID, PK)
        - execution_id (FK)
        - metric_type (tokens, cost, duration, etc.)
        - value (DECIMAL)
        - metadata (JSONB: model, agent, task)
        - recorded_at
      </metrics>

      <api_keys>
        - id (UUID, PK)
        - user_id (FK)
        - team_id (FK)
        - name
        - key_hash
        - permissions (JSONB)
        - rate_limit
        - created_at
        - last_used_at
        - expires_at
        - is_active
      </api_keys>

      <webhooks>
        - id (UUID, PK)
        - team_id (FK)
        - url
        - events (JSONB: array of event types)
        - secret_hash
        - is_active
        - created_at
      </webhooks>

      <alerts>
        - id (UUID, PK)
        - team_id (FK)
        - name
        - condition (JSONB)
        - channels (JSONB: slack, email, webhook)
        - is_active
        - created_at
      </alerts>
    </tables>
  </database_schema>

  <api_endpoints>
    <authentication>
      - POST /api/auth/register
      - POST /api/auth/login
      - POST /api/auth/logout
      - POST /api/auth/refresh
      - GET /api/auth/me
    </authentication>

    <crews>
      - GET /api/crews
      - POST /api/crews
      - GET /api/crews/{id}
      - PUT /api/crews/{id}
      - DELETE /api/crews/{id}
      - POST /api/crews/{id}/deploy
      - POST /api/crews/{id}/stop
      - POST /api/crews/{id}/run (returns execution_id, SSE stream endpoint)
      - GET /api/crews/{id}/executions
    </crews>

    <executions>
      - GET /api/executions
      - GET /api/executions/{id}
      - POST /api/executions/{id}/cancel
      - GET /api/executions/{id}/stream (SSE endpoint for real-time logs/status)
      - GET /api/executions/{id}/traces
      - GET /api/executions/{id}/logs
      - GET /api/executions/{id}/metrics
    </executions>

    <templates>
      - GET /api/templates/agents
      - POST /api/templates/agents
      - GET /api/templates/agents/{id}
      - PUT /api/templates/agents/{id}
      - DELETE /api/templates/agents/{id}
    </templates>

    <tools>
      - GET /api/tools
      - POST /api/tools
      - GET /api/tools/{id}
      - PUT /api/tools/{id}
      - DELETE /api/tools/{id}
    </tools>

    <analytics>
      - GET /api/analytics/overview
      - GET /api/analytics/executions
      - GET /api/analytics/costs
      - GET /api/analytics/performance
      - GET /api/analytics/export
    </analytics>

    <api_keys>
      - GET /api/api-keys
      - POST /api/api-keys
      - DELETE /api/api-keys/{id}
      - POST /api/api-keys/{id}/regenerate
    </api_keys>

    <webhooks>
      - GET /api/webhooks
      - POST /api/webhooks
      - PUT /api/webhooks/{id}
      - DELETE /api/webhooks/{id}
      - POST /api/webhooks/{id}/test
    </webhooks>

    <teams>
      - GET /api/teams
      - POST /api/teams
      - GET /api/teams/{id}
      - PUT /api/teams/{id}
      - GET /api/teams/{id}/members
      - POST /api/teams/{id}/members
      - DELETE /api/teams/{id}/members/{user_id}
    </teams>
  </api_endpoints>

  <sse_events>
    <description>
      POST /api/crews/{id}/run 또는 GET /api/executions/{id}/stream에서
      SSE로 스트리밍되는 이벤트 타입들
    </description>
    <events>
      - event: execution_started
        data: { execution_id, crew_id, started_at }

      - event: agent_started
        data: { agent_name, task_name, trace_id }

      - event: agent_completed
        data: { agent_name, output, duration, tokens }

      - event: task_started
        data: { task_name, agent_name, trace_id }

      - event: task_completed
        data: { task_name, output, duration }

      - event: llm_call
        data: { model, input_tokens, output_tokens, duration, cost }

      - event: tool_call
        data: { tool_name, inputs, outputs, duration }

      - event: log
        data: { level, message, timestamp, trace_id }

      - event: error
        data: { error_type, message, trace_id, stack_trace }

      - event: execution_completed
        data: { execution_id, status, outputs, total_duration, total_cost }
    </events>
  </sse_events>

  <ui_layout>
    <main_structure>
      - Sidebar + Main content layout
      - Desktop 우선 반응형 (태블릿 기본 지원)
      - Dark mode / Light mode 지원
    </main_structure>

    <sidebar>
      - Logo and team selector
      - Navigation menu:
        - Dashboard (overview)
        - Crews (list and management)
        - Executions (history)
        - Templates (agent templates)
        - Tools (tool repository)
        - Analytics (reports)
        - Settings
      - User profile at bottom
    </sidebar>

    <pages>
      <dashboard>
        - Overview stats cards (total crews, active executions, today's cost)
        - Recent executions list
        - Quick actions (run crew, create crew)
        - Metrics charts (executions over time, cost trends)
      </dashboard>

      <crews_list>
        - Crew cards with status badges
        - Search and filter
        - Create new crew button
        - Quick actions (run, edit, delete)
      </crews_list>

      <crew_detail>
        - Tabs: Overview, Agents, Tasks, Executions, Settings
        - Visual workflow editor
        - Code view (YAML/JSON)
        - Run button with input form
        - Deployment status
      </crew_detail>

      <execution_detail>
        - Execution status and timeline
        - Real-time log stream
        - Trace tree view
        - Metrics summary
        - Input/Output display
      </execution_detail>

      <analytics>
        - Date range selector
        - Cost breakdown charts
        - Execution success rate
        - Token usage by model
        - Performance trends
        - Export options
      </analytics>

      <settings>
        - Profile settings
        - Team management
        - API keys
        - Webhooks
        - Alerts configuration
        - Theme preferences
      </settings>
    </pages>
  </ui_layout>

  <additional_features>
    <theme>Dark mode / Light mode switching</theme>
    <realtime>SSE for real-time updates</realtime>
    <documentation>Swagger API documentation</documentation>
    <containerization>Docker Compose for local development</containerization>
    <testing>Playwright E2E tests</testing>
  </additional_features>

  <implementation_phases>
    <phase number="1">
      <title>Foundation</title>
      <tasks>
        - FastAPI 프로젝트 설정
        - PostgreSQL + SQLAlchemy 설정
        - 인증 시스템 (JWT)
        - React + Vite + shadcn/ui 설정
        - 기본 레이아웃 구현
      </tasks>
    </phase>

    <phase number="2">
      <title>Core Crew Management</title>
      <tasks>
        - Crew CRUD API
        - Agent/Task 설정 UI
        - CrewAI SDK 통합
        - Crew 실행 기능
        - SSE 스트리밍 구현
      </tasks>
    </phase>

    <phase number="3">
      <title>Observability</title>
      <tasks>
        - Trace 시스템 구현
        - 실행 로그 수집
        - 실시간 모니터링 대시보드
        - 메트릭 수집 및 차트
      </tasks>
    </phase>

    <phase number="4">
      <title>Advanced Features</title>
      <tasks>
        - 시각적 워크플로우 에디터
        - Agent 템플릿 라이브러리
        - Tool 저장소
        - Webhook/Alert 시스템
        - 분석 리포트
      </tasks>
    </phase>

    <phase number="5">
      <title>Polish</title>
      <tasks>
        - Docker 컨테이너화
        - E2E 테스트
        - API 문서화
        - 성능 최적화
        - UI/UX 개선
      </tasks>
    </phase>
  </implementation_phases>

  <success_criteria>
    <functionality>
      - Crew 생성, 배포, 실행이 안정적으로 동작
      - SSE 기반 실시간 로그 스트리밍 정상 작동
      - 실행 추적 및 메트릭 수집 정확
      - API 키 기반 외부 연동 가능
    </functionality>

    <user_experience>
      - 직관적인 Crew 설정 UI
      - 실시간 실행 상태 확인 가능
      - 명확한 에러 메시지 및 피드백
      - 빠른 페이지 로딩
    </user_experience>

    <technical_quality>
      - 깔끔한 코드 구조
      - 적절한 에러 핸들링
      - API 문서화 완료
      - Docker로 쉬운 배포
    </technical_quality>
  </success_criteria>
</project_specification>
